---
import { BLUESKY_HANDLE } from '../consts';

interface BlueskyImage {
  thumb: string;
  fullsize: string;
  alt: string;
}

interface BlueskyPost {
  uri: string;
  cid: string;
  author: {
    handle: string;
    displayName: string;
    avatar?: string;
  };
  record: {
    text: string;
    createdAt: string;
  };
  embed?: {
    $type: string;
    images?: BlueskyImage[];
    playlist?: string;
    thumbnail?: string;
    alt?: string;
    external?: {
      uri: string;
      title: string;
      description: string;
      thumb?: string;
    };
  };
}

let posts: BlueskyPost[] = [];
let error = null;

try {
  const response = await fetch(
    `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${BLUESKY_HANDLE}&limit=3`
  );

  if (response.ok) {
    const data = await response.json();
    posts = data.feed.map((item: any) => item.post);
  } else {
    error = 'Failed to load posts';
  }
} catch (e) {
  error = 'Failed to connect to Bluesky';
  console.error('Bluesky feed error:', e);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days}d ago`;

  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function getPostUrl(uri: string) {
  const parts = uri.replace('at://', '').split('/');
  const handle = parts[0];
  const postId = parts[parts.length - 1];
  return `https://bsky.app/profile/${handle}/post/${postId}`;
}
---

<section class="my-12">
  <div class="flex justify-between items-center mb-8 border-b-2 border-cyber-purple pb-4">
    <h2 class="m-0 text-3xl">Latest Updates via Bluesky</h2>
    <a href={`https://bsky.app/profile/${BLUESKY_HANDLE}`} target="_blank" rel="noopener noreferrer" class="text-sm uppercase tracking-widest font-semibold px-4 py-2 border border-cyber-cyan rounded transition-all duration-300 hover:bg-cyber-cyan/10 hover:shadow-glow-cyan">
      View on Bluesky →
    </a>
  </div>

  {error ? (
    <div class="p-8 text-center text-[#ff6b6b] border border-[#ff6b6b] rounded-lg bg-[#ff6b6b]/10">
      {error}
    </div>
  ) : (
    <div class="grid grid-cols-[repeat(auto-fit,minmax(min(350px,100%),1fr))] gap-8">
      {posts.map((post) => (
        <article class="p-6 bg-black/50 border border-cyber-purple rounded-lg transition-all duration-300 box-border hover:border-cyber-cyan hover:shadow-[0_0_20px_rgba(177,255,236,0.2)] hover:-translate-y-0.5">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
              {post.author.avatar && (
                <img src={post.author.avatar} alt={post.author.displayName} class="w-12 h-12 rounded-full border-2 border-cyber-purple" />
              )}
              <div class="flex flex-col">
                <span class="font-semibold text-cyber-cyan">{post.author.displayName}</span>
                <span class="text-sm text-cyber-gray">@{post.author.handle}</span>
              </div>
            </div>
            <time class="text-sm text-cyber-gray">{formatDate(post.record.createdAt)}</time>
          </div>

          <p class="my-4 leading-relaxed text-cyber-gray-dark whitespace-pre-wrap">{post.record.text}</p>

          {post.embed?.images && post.embed.images.length > 0 && (
            <div class={post.embed.images.length === 1 ? 'my-4 rounded-lg overflow-hidden max-w-full' : 'my-4 rounded-lg overflow-hidden grid grid-cols-2 gap-2'}>
              {post.embed.images.map((image) => (
                <a href={getPostUrl(post.uri)} target="_blank" rel="noopener noreferrer">
                  <img
                    src={image.fullsize}
                    alt={image.alt || 'Post image'}
                    loading="lazy"
                    class={post.embed.images.length === 1 ? 'w-full h-auto block rounded-lg border border-cyber-purple transition-all duration-300 hover:border-cyber-cyan hover:shadow-[0_0_15px_rgba(177,255,236,0.3)]' : 'w-full h-[200px] object-cover rounded-lg border border-cyber-purple transition-all duration-300 hover:border-cyber-cyan hover:shadow-[0_0_15px_rgba(177,255,236,0.3)]'}
                  />
                </a>
              ))}
            </div>
          )}

          {post.embed?.$type === 'app.bsky.embed.video#view' && post.embed.playlist && (
            <div class="my-4 rounded-lg overflow-hidden">
              <video
                controls
                poster={post.embed.thumbnail}
                preload="metadata"
                class="w-full h-auto block rounded-lg border border-cyber-purple bg-black transition-all duration-300 hover:border-cyber-cyan hover:shadow-[0_0_15px_rgba(177,255,236,0.3)]"
              >
                <source src={post.embed.playlist} type="application/x-mpegURL" />
                Your browser does not support the video tag.
              </video>
            </div>
          )}

          {post.embed?.$type === 'app.bsky.embed.external' && post.embed.external && (
            <a href={post.embed.external.uri} target="_blank" rel="noopener noreferrer" class="flex gap-4 p-4 my-4 bg-black/30 border border-cyber-purple rounded-lg no-underline transition-all duration-300 hover:border-cyber-cyan hover:bg-cyber-cyan/5">
              {post.embed.external.thumb && (
                <img src={post.embed.external.thumb} alt={post.embed.external.title} class="w-[120px] h-[120px] object-cover rounded border border-cyber-purple flex-shrink-0" />
              )}
              <div class="flex-1 flex flex-col gap-2">
                <div class="font-semibold text-cyber-cyan text-base">{post.embed.external.title}</div>
                {post.embed.external.description && (
                  <div class="text-sm text-cyber-gray leading-snug line-clamp-2">{post.embed.external.description}</div>
                )}
              </div>
            </a>
          )}

          <a href={getPostUrl(post.uri)} target="_blank" rel="noopener noreferrer" class="inline-block text-sm mt-2 text-cyber-cyan font-medium">
            View post →
          </a>
        </article>
      ))}
    </div>
  )}
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 1024px) {
    .grid-cols-\[repeat\(auto-fit\2c minmax\(min\(350px\2c 100\%\)\2c 1fr\)\)\] {
      grid-template-columns: 1fr !important;
    }
  }

  @media (max-width: 720px) {
    section {
      margin: 2rem 0 !important;
    }

    .flex.justify-between {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 1rem !important;
    }

    article {
      padding: 1rem !important;
    }

    .w-12.h-12 {
      width: 40px !important;
      height: 40px !important;
    }

    .grid-cols-2 {
      grid-template-columns: 1fr !important;
    }

    .h-\[200px\] {
      height: 250px !important;
    }

    .flex.gap-4 {
      flex-direction: column !important;
    }

    .w-\[120px\].h-\[120px\] {
      width: 100% !important;
      height: 200px !important;
    }
  }
</style>
